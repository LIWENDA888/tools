<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自在文本编辑器 Pro - 自在造字(ZIZAO)</title>
    <meta name="description" content="自在造字，专注字体字库产品制作与分享">
    <meta name="author" content="自在造字">
    <meta property="og:title" content="自在文本编辑器 Pro - 自在造字(ZIZAO)">
    <meta property="og:image" content="https://pic3.fukit.cn/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251123/AR9P/ico.ico">
    <meta property="og:url" content="https://www.zizao.top">
    <meta property="og:type" content="website">
    <link rel="icon" href="https://pic3.fukit.cn/autoupload/NWINCyTOTWqNUcPQazQq69iO_OyvX7mIgxFBfDMDErs/20251101/8hkj/ico.ico" type="zizaoicon">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.1/lib/index.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              slate: {
                50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 300: '#cbd5e1',
                400: '#94a3b8', 500: '#64748b', 600: '#475569', 700: '#334155',
                800: '#1e293b', 850: '#151e2e', 900: '#0f172a', 950: '#020617',
              },
            },
            fontFamily: {
              sans: ['Inter', 'Noto Sans SC', 'system-ui', 'sans-serif'],
              serif: ['Noto Serif SC', 'serif'],
              mono: ['Fira Code', 'monospace'],
            },
            animation: {
              'fade-in': 'fadeIn 0.2s ease-out',
              'zoom-in': 'zoomIn 0.2s ease-out',
            },
            keyframes: {
              fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
              zoomIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
            }
          },
        },
      }
    </script>

    <!-- 2. Styles -->
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Serif+SC:wght@400;700&family=Fira+Code&display=swap');
      
      body { font-family: 'Noto Sans SC', 'Inter', sans-serif; overflow: hidden; }
      .no-scrollbar::-webkit-scrollbar { display: none; }
      .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
      .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
      .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
      .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
      .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
      .light .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
      .light .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      
      /* Loading Screen Styles */
      #app-loading {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #f8fafc; z-index: 99999;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        color: #475569; transition: opacity 0.5s;
      }
      .spinner {
        width: 40px; height: 40px; border: 4px solid #cbd5e1; border-top-color: #059669; border-radius: 50%;
        animation: spin 1s linear infinite; margin-bottom: 16px;
      }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- 3. React & ReactDOM (UMD - Global Variables for Stability) -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel (Standalone) -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>

    <!-- 5. Pinyin Pro UMD -->
    <script src="https://cdn.jsdelivr.net/npm/pinyin-pro@3.18.3/dist/index.js"></script>
  <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.30.0",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "react-dom": "https://aistudiocdn.com/react-dom@^19.2.0",
    "pinyin-pro": "https://aistudiocdn.com/pinyin-pro@^3.27.0"
  }
}
</script>
</head>
  <body>
    <!-- Loading State -->
    <div id="app-loading">
      <div class="spinner"></div>
      <p>正在加载资源...</p>
      <p style="font-size: 12px; margin-top: 10px; color: #94a3b8;">无需配置，双击即用</p>
    </div>

    <div id="root"></div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="text/babel" data-presets="env,react">
      // --- ERROR SAFETY CHECK ---
      if (!window.React || !window.ReactDOM) {
        document.getElementById('app-loading').innerHTML = '<p style="color:red">核心库加载失败。请检查网络。</p>';
        throw new Error("React libs missing");
      }

      // --- GLOBALS DESTUCTURING ---
      const { useState, useEffect, useRef, useMemo, useCallback } = React;
      const { createPortal } = ReactDOM;
      // Safety check for pinyin
      const pinyinProLib = window.pinyinPro || { pinyin: (t) => t }; 
      const { pinyin } = pinyinProLib;

      // --- INLINE ICONS (Pure SVG) ---
      const IconBase = ({ size = 24, className = "", children, ...props }) => (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width={size} 
          height={size} 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round" 
          className={className}
          {...props}
        >
          {children}
        </svg>
      );

      const Icons = {
        Home: (p) => <IconBase {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></IconBase>,
        Minus: (p) => <IconBase {...p}><path d="M5 12h14"/></IconBase>,
        Plus: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>,
        MoveVertical: (p) => <IconBase {...p}><polyline points="8 18 12 22 16 18"/><polyline points="8 6 12 2 16 6"/><line x1="12" x2="12" y1="2" y2="22"/></IconBase>,
        AlignLeft: (p) => <IconBase {...p}><line x1="21" x2="3" y1="6" y2="6"/><line x1="15" x2="3" y1="12" y2="12"/><line x1="17" x2="3" y1="18" y2="18"/></IconBase>,
        AlignCenter: (p) => <IconBase {...p}><line x1="21" x2="3" y1="6" y2="6"/><line x1="17" x2="7" y1="12" y2="12"/><line x1="19" x2="5" y1="18" y2="18"/></IconBase>,
        AlignRight: (p) => <IconBase {...p}><line x1="21" x2="3" y1="6" y2="6"/><line x1="21" x2="9" y1="12" y2="12"/><line x1="21" x2="7" y1="18" y2="18"/></IconBase>,
        Minimize2: (p) => <IconBase {...p}><polyline points="4 14 10 14 10 20"/><polyline points="20 10 14 10 14 4"/><line x1="14" x2="21" y1="10" y2="3"/><line x1="3" x2="10" y1="21" y2="14"/></IconBase>,
        Maximize2: (p) => <IconBase {...p}><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" x2="14" y1="3" y2="10"/><line x1="3" x2="10" y1="21" y2="14"/></IconBase>,
        Sun: (p) => <IconBase {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></IconBase>,
        Moon: (p) => <IconBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></IconBase>,
        Search: (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>,
        X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></IconBase>,
        Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></IconBase>,
        Copy: (p) => <IconBase {...p}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>,
        FileText: (p) => <IconBase {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></IconBase>,
        FolderOpen: (p) => <IconBase {...p}><path d="m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2"/></IconBase>,
        Eraser: (p) => <IconBase {...p}><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 11 9 9"/></IconBase>,
        Languages: (p) => <IconBase {...p}><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></IconBase>,
        SplitSquareHorizontal: (p) => <IconBase {...p}><path d="M8 19H5c-1 0-2-1-2-2V7c0-1 1-2 2-2h3"/><path d="M16 5h3c1 0 2 1 2 2v10c0 1-1 2-2 2h-3"/><line x1="12" x2="12" y1="4" y2="20"/></IconBase>,
        ArrowUpToLine: (p) => <IconBase {...p}><path d="M5 3h14"/><path d="m18 13-6-6-6 6"/><path d="M12 7v14"/></IconBase>,
        ArrowDownToLine: (p) => <IconBase {...p}><path d="M12 17V3"/><path d="m6 11 6 6 6-6"/><path d="M19 21H5"/></IconBase>,
        Check: (p) => <IconBase {...p}><polyline points="20 6 9 17 4 12"/></IconBase>,
        Loader2: (p) => <IconBase {...p}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>,
        ArrowLeft: (p) => <IconBase {...p}><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></IconBase>,
        ArrowRight: (p) => <IconBase {...p}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>
      };

      // --- HELPERS ---

      // Service: Pinyin (Local)
      const convertToPinyinLocal = (text, type) => {
        if (!text || !text.trim()) return "";
        let options = { v: true, nonZh: 'consecutive' };
        
        if (type === 'upper') {
            options.toneType = 'none';
        } else {
            options.toneType = 'symbol';
        }
        
        let result = pinyin(text, options);
        if (type === 'upper') result = result.toUpperCase();
        return result;
      };

      // Service: Diff (Local - Set Based)
      const compareTextsLocal = (textA, textB) => {
        const cleanA = textA.replace(/\r\n/g, "\n");
        const cleanB = textB.replace(/\r\n/g, "\n");
        
        const setA = new Set(cleanA.split(''));
        const setB = new Set(cleanB.split(''));
        
        const uniqueToLeft = [...setA].filter(x => !setB.has(x) && x.trim() !== '').sort();
        const uniqueToRight = [...setB].filter(x => !setA.has(x) && x.trim() !== '').sort();

        const intersection = new Set([...setA].filter(x => setB.has(x)));
        const union = new Set([...setA, ...setB]);
        
        let similarityScore = 0;
        if (union.size > 0) {
            similarityScore = Math.round((intersection.size / union.size) * 100);
        } else if (textA === textB) {
            similarityScore = 100;
        }

        let summary = "两段文本完全一致。";
        if (similarityScore < 100) {
            summary = `文本相似度为 ${similarityScore}%。左侧有 ${uniqueToLeft.length} 个独有字符，右侧有 ${uniqueToRight.length} 个独有字符。`;
        }

        return { uniqueToLeft, uniqueToRight, similarityScore, summary };
      };

      // --- COMPONENTS ---

      // Toast Notification
      const Toast = ({ message }) => (
        <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-[10000] animate-in slide-in-from-bottom-5 fade-in duration-300 pointer-events-none">
           <div className="bg-slate-800/90 backdrop-blur text-white px-5 py-2.5 rounded-full shadow-2xl flex items-center gap-2 border border-slate-700/50">
             <div className="bg-emerald-500 rounded-full p-0.5"><Icons.Check size={12} className="text-white" /></div>
             <span className="text-sm font-medium tracking-wide">{message}</span>
           </div>
        </div>
      );

      // Tooltip - Fixed Origin Bug
      const Tooltip = ({ content, children, placement = 'top' }) => {
        const [tooltipState, setTooltipState] = useState({
          isVisible: false,
          top: 0,
          left: 0
        });
        const triggerRef = useRef(null);

        const calculatePosition = () => {
          if (triggerRef.current) {
            const rect = triggerRef.current.getBoundingClientRect();
            let top = 0;
            let left = 0;
            const gap = 8;

            switch (placement) {
              case 'top': top = rect.top - gap; left = rect.left + rect.width / 2; break;
              case 'bottom': top = rect.bottom + gap; left = rect.left + rect.width / 2; break;
              case 'left': top = rect.top + rect.height / 2; left = rect.left - gap; break;
              case 'right': top = rect.top + rect.height / 2; left = rect.right + gap; break;
            }
            return { top, left };
          }
          return { top: 0, left: 0 };
        };

        const handleMouseEnter = () => {
          const { top, left } = calculatePosition();
          setTooltipState({ isVisible: true, top, left });
        };

        const handleMouseLeave = () => {
          setTooltipState(prev => ({ ...prev, isVisible: false }));
        };

        useEffect(() => {
          if (tooltipState.isVisible) {
            const handleScrollOrResize = () => {
               const { top, left } = calculatePosition();
               setTooltipState(prev => ({ ...prev, top, left }));
            };
            window.addEventListener('scroll', handleScrollOrResize);
            window.addEventListener('resize', handleScrollOrResize);
            return () => {
              window.removeEventListener('scroll', handleScrollOrResize);
              window.removeEventListener('resize', handleScrollOrResize);
            };
          }
        }, [tooltipState.isVisible, placement]);

        return (
          <React.Fragment>
            <div 
              ref={triggerRef}
              className="inline-flex"
              onMouseEnter={handleMouseEnter}
              onMouseLeave={handleMouseLeave}
            >
              {children}
            </div>
            {tooltipState.isVisible && createPortal(
              <div 
                className="fixed z-[9999] px-2.5 py-1.5 text-xs font-medium text-slate-100 bg-slate-800 dark:bg-slate-700 rounded shadow-lg whitespace-nowrap pointer-events-none animate-in fade-in zoom-in-95 duration-150 border border-slate-700/50"
                style={{
                  top: tooltipState.top,
                  left: tooltipState.left,
                  transform: placement === 'left' || placement === 'right' 
                    ? 'translateY(-50%) translateX(' + (placement === 'left' ? '-100%' : '0') + ')'
                    : 'translateX(-50%) translateY(' + (placement === 'top' ? '-100%' : '0') + ')'
                }}
              >
                {content}
              </div>,
              document.body
            )}
          </React.Fragment>
        );
      };

      // Modal
      const Modal = ({ isOpen, onClose, title, children, width = 'max-w-xl' }) => {
        if (!isOpen) return null;

        return (
          <div 
            className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in fade-in duration-200"
            onClick={onClose}
          >
            <div 
              className={`bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl w-full ${width} flex flex-col max-h-[90vh] overflow-hidden animate-in zoom-in-95 duration-200 transition-colors`}
              onClick={(e) => e.stopPropagation()}
            >
              <div className="flex items-center justify-between p-4 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50">
                <h3 className="text-lg font-semibold text-slate-800 dark:text-white">{title}</h3>
                <button 
                  onClick={onClose}
                  className="p-1 hover:bg-slate-200 dark:hover:bg-slate-800 rounded-full transition-colors text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white"
                >
                  <Icons.X size={20} />
                </button>
              </div>
              <div className="p-6 overflow-y-auto custom-scrollbar bg-white dark:bg-slate-900">
                {children}
              </div>
            </div>
          </div>
        );
      };

      // Dedup View
      const DedupView = ({ result, onApply, triggerToast }) => {
        const [copied, setCopied] = useState(false);

        if (!result) return <div className="text-slate-600 dark:text-slate-400">暂无内容可处理。</div>;

        const handleCopyResult = () => {
          navigator.clipboard.writeText(result.cleaned);
          setCopied(true);
          triggerToast("已复制");
          setTimeout(() => setCopied(false), 2000);
        };

        const handleCopyChar = (char) => {
            navigator.clipboard.writeText(char);
            triggerToast("已复制");
        };

        return (
          <div className="space-y-6">
            <div className="bg-slate-50 dark:bg-slate-950 p-4 rounded-lg border border-slate-200 dark:border-slate-800">
              <h4 className="text-sm font-medium text-slate-500 dark:text-slate-400 mb-2">重复字符 ({result.removedCount})</h4>
              <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto custom-scrollbar">
                {result.removedChars.length === 0 ? (
                  <span className="text-slate-400 dark:text-slate-500 italic text-sm">未发现重复字符。</span>
                ) : (
                  result.removedChars.map((char, i) => (
                    <button 
                      key={i} 
                      onClick={() => handleCopyChar(char)}
                      title="点击复制"
                      className="inline-flex items-center justify-center w-8 h-8 rounded bg-red-100 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-200 dark:border-red-900/30 font-mono text-sm hover:scale-110 active:scale-95 transition-transform cursor-pointer"
                    >
                      {char === ' ' ? '空' : char}
                    </button>
                  ))
                )}
              </div>
            </div>

            <div>
              <div className="flex justify-between items-center mb-2">
                  <h4 className="text-sm font-medium text-slate-500 dark:text-slate-400">去重预览</h4>
                   <button 
                    onClick={handleCopyResult}
                    className="flex items-center gap-1 text-xs text-emerald-600 dark:text-emerald-400 hover:text-emerald-500 transition-colors"
                  >
                    {copied ? <Icons.Check size={14} /> : <Icons.Copy size={14} />}
                    {copied ? "已复制" : "复制结果"}
                  </button>
              </div>
              <div className="p-3 bg-slate-100 dark:bg-slate-800/50 rounded-lg text-slate-700 dark:text-slate-300 text-sm max-h-40 overflow-y-auto whitespace-pre-wrap font-mono border border-slate-200 dark:border-transparent">
                  {result.cleaned}
              </div>
            </div>

            <button
              onClick={() => onApply(result.cleaned)}
              className="w-full py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium transition-colors"
            >
              替换编辑器内容
            </button>
          </div>
        );
      };

      // Pinyin View
      const PinyinView = ({ currentText, triggerToast }) => {
        const [loading, setLoading] = useState(false);
        const [result, setResult] = useState(null);
        const [copied, setCopied] = useState(false);

        const handleConvert = async (type) => {
          if (!currentText.trim()) return;
          setLoading(true);
          await new Promise(r => setTimeout(r, 100)); 
          const res = convertToPinyinLocal(currentText, type);
          setResult(res);
          setLoading(false);
        };

        const handleCopy = () => {
          if (result) {
              navigator.clipboard.writeText(result);
              setCopied(true);
              triggerToast("已复制");
              setTimeout(() => setCopied(false), 2000);
          }
        };

        return (
          <div className="space-y-6">
            <div className="grid grid-cols-2 gap-4">
               <button
                  onClick={() => handleConvert('normal')}
                  disabled={loading || !currentText.trim()}
                  className="py-3 bg-emerald-600 hover:bg-emerald-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2 shadow-sm"
               >
                 {loading ? <Icons.Loader2 className="animate-spin" size={18} /> : '转换为拼音'}
               </button>
               <button
                  onClick={() => handleConvert('upper')}
                  disabled={loading || !currentText.trim()}
                  className="py-3 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2 shadow-sm"
               >
                 {loading ? <Icons.Loader2 className="animate-spin" size={18} /> : '转换为大写'}
               </button>
            </div>

            {result && (
              <div className="animate-in fade-in slide-in-from-bottom-2">
                  <div className="flex justify-between items-center mb-2">
                      <h4 className="text-sm font-medium text-slate-500 dark:text-slate-400">结果</h4>
                      <button 
                        onClick={handleCopy}
                        className="flex items-center gap-1 text-xs text-emerald-600 dark:text-emerald-400 hover:text-emerald-500 transition-colors"
                      >
                        {copied ? <Icons.Check size={14} /> : <Icons.Copy size={14} />}
                        {copied ? "已复制" : "复制"}
                      </button>
                  </div>
                  <div className="p-4 bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg text-slate-800 dark:text-slate-200 font-mono text-sm leading-relaxed max-h-60 overflow-y-auto custom-scrollbar select-text">
                      {result}
                  </div>
              </div>
            )}
          </div>
        );
      };

      // Diff View (Local)
      const DiffView = ({ triggerToast }) => {
          const [leftText, setLeftText] = useState("");
          const [rightText, setRightText] = useState("");
          const [loading, setLoading] = useState(false);
          const [result, setResult] = useState(null);

          const handleCompare = async () => {
              if (!leftText && !rightText) return;
              setLoading(true);
              await new Promise(r => setTimeout(r, 200));
              const res = compareTextsLocal(leftText, rightText);
              setResult(res);
              setLoading(false);
          };

          const handleCopyChar = (char) => {
             navigator.clipboard.writeText(char);
             triggerToast("已复制");
          };

          return (
              <div className="flex flex-col h-[70vh]">
                  <div className="flex flex-1 gap-4 min-h-0 mb-4">
                      <div className="flex-1 flex flex-col gap-2">
                          <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">原文 / 左侧文本</label>
                          <textarea 
                              className="flex-1 w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm text-slate-800 dark:text-slate-300 focus:outline-none focus:border-indigo-500 resize-none custom-scrollbar"
                              placeholder="在此粘贴文本 A..."
                              value={leftText}
                              onChange={(e) => setLeftText(e.target.value)}
                          />
                      </div>
                      <div className="flex-1 flex flex-col gap-2">
                          <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider">比对 / 右侧文本</label>
                          <textarea 
                              className="flex-1 w-full bg-slate-50 dark:bg-slate-950 border border-slate-200 dark:border-slate-800 rounded-lg p-3 text-sm text-slate-800 dark:text-slate-300 focus:outline-none focus:border-indigo-500 resize-none custom-scrollbar"
                              placeholder="在此粘贴文本 B..."
                              value={rightText}
                              onChange={(e) => setRightText(e.target.value)}
                          />
                      </div>
                  </div>

                  <div className="flex justify-center mb-6">
                       <button
                          onClick={handleCompare}
                          disabled={loading}
                          className="px-8 py-2 bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-white rounded-full font-medium transition-colors flex items-center gap-2 shadow-lg shadow-indigo-900/20"
                      >
                          {loading && <Icons.Loader2 className="animate-spin" size={18} />}
                          {loading ? '正在分析...' : '开始比对'}
                      </button>
                  </div>

                  {result && (
                      <div className="flex-1 bg-slate-100 dark:bg-slate-800/30 rounded-xl border border-slate-200 dark:border-slate-800 p-4 overflow-y-auto custom-scrollbar animate-in slide-in-from-bottom-4">
                          <div className="flex items-center gap-3 mb-4">
                              <span className="text-xl font-bold text-slate-800 dark:text-white">差异分析</span>
                              <span className="px-2 py-0.5 rounded-full bg-slate-200 dark:bg-slate-700 text-xs text-slate-600 dark:text-slate-300">相似度: {result.similarityScore}%</span>
                          </div>
                          <p className="text-sm text-slate-600 dark:text-slate-400 mb-4">{result.summary}</p>
                          
                          <div className="grid grid-cols-2 gap-6">
                              <div>
                                   <h5 className="text-xs font-bold text-rose-500 dark:text-rose-400 uppercase mb-2 flex items-center gap-2">
                                      <Icons.ArrowLeft size={14} /> 仅在左侧出现 (A)
                                   </h5>
                                   <div className="flex flex-wrap gap-2">
                                      {result.uniqueToLeft.length > 0 ? result.uniqueToLeft.map((item, i) => (
                                          <button 
                                            key={i} 
                                            onClick={() => handleCopyChar(item)}
                                            className="px-2 py-1 bg-rose-100 dark:bg-rose-950/40 border border-rose-200 dark:border-rose-900/50 text-rose-600 dark:text-rose-300 text-xs rounded font-mono hover:scale-110 active:scale-95 transition-transform cursor-pointer"
                                          >
                                              {item}
                                          </button>
                                      )) : <span className="text-slate-400 dark:text-slate-600 text-xs italic">无。</span>}
                                   </div>
                              </div>
                              <div>
                                   <h5 className="text-xs font-bold text-emerald-500 dark:text-emerald-400 uppercase mb-2 flex items-center gap-2">
                                      仅在右侧出现 (B) <Icons.ArrowRight size={14} />
                                   </h5>
                                   <div className="flex flex-wrap gap-2">
                                      {result.uniqueToRight.length > 0 ? result.uniqueToRight.map((item, i) => (
                                          <button 
                                            key={i} 
                                            onClick={() => handleCopyChar(item)}
                                            className="px-2 py-1 bg-emerald-100 dark:bg-emerald-950/40 border border-emerald-200 dark:border-emerald-900/50 text-emerald-600 dark:text-emerald-300 text-xs rounded font-mono hover:scale-110 active:scale-95 transition-transform cursor-pointer"
                                          >
                                              {item}
                                          </button>
                                      )) : <span className="text-slate-400 dark:text-slate-600 text-xs italic">无。</span>}
                                   </div>
                              </div>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      // --- MAIN APP COMPONENT ---

      function App() {
        const [documents, setDocuments] = useState(() => {
          try {
            const savedDocs = localStorage.getItem('zen_documents');
            if (savedDocs) return JSON.parse(savedDocs);
            const legacyContent = localStorage.getItem('zen_content');
            if (legacyContent) return [{ id: 'doc-' + Date.now(), title: '未命名-1', content: legacyContent, updatedAt: Date.now() }];
          } catch (e) {}
          return [{ id: 'doc-' + Date.now(), title: '未命名-1', content: '', updatedAt: Date.now() }];
        });

        const [activeDocId, setActiveDocId] = useState(() => {
           return localStorage.getItem('zen_active_doc_id') || documents[0]?.id || '';
        });

        const [editingDocId, setEditingDocId] = useState(null);
        const [tempTitle, setTempTitle] = useState("");
        
        const [theme, setTheme] = useState('light');
        const [config, setConfig] = useState({
          fontSize: 18,
          alignment: 'left',
          spacing: 'loose',
          fontFamily: 'sans',
          width: 'full',
        });
        
        const [cursorStats, setCursorStats] = useState({ line: 1, col: 1 });
        const [isSearchOpen, setIsSearchOpen] = useState(false);
        const [searchTerm, setSearchTerm] = useState("");
        const [toastMessage, setToastMessage] = useState(null);
        
        // Modals
        const [dedupModalOpen, setDedupModalOpen] = useState(false);
        const [dedupResult, setDedupResult] = useState(null);
        const [pinyinModalOpen, setPinyinModalOpen] = useState(false);
        const [diffModalOpen, setDiffModalOpen] = useState(false);

        const editorRef = useRef(null);
        const searchInputRef = useRef(null);
        const fileInputRef = useRef(null);
        const renameInputRef = useRef(null);

        const activeDoc = useMemo(() => 
          documents.find(d => d.id === activeDocId) || documents[0], 
        [documents, activeDocId]);

        const text = activeDoc?.content || '';

        // Effects
        useEffect(() => {
          localStorage.setItem('zen_documents', JSON.stringify(documents));
        }, [documents]);

        useEffect(() => {
          localStorage.setItem('zen_active_doc_id', activeDocId);
        }, [activeDocId]);
        
        useEffect(() => {
          const root = document.documentElement;
          if (theme === 'dark') {
              root.classList.add('dark');
              root.classList.remove('light');
          } else {
              root.classList.add('light');
              root.classList.remove('dark');
          }
        }, [theme]);

        useEffect(() => {
          if (editingDocId && renameInputRef.current) {
            renameInputRef.current.focus();
            renameInputRef.current.select();
          }
        }, [editingDocId]);

        useEffect(() => {
          const handleKeyDown = (e) => {
              if ((e.metaKey || e.ctrlKey) && e.key === 'f') {
                  e.preventDefault();
                  setIsSearchOpen(true);
                  setTimeout(() => searchInputRef.current?.focus(), 100);
              }
          };
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, []);

        // Logic
        const triggerToast = useCallback((msg) => {
           setToastMessage(msg);
           setTimeout(() => setToastMessage(null), 2000);
        }, []);

        const updateActiveDoc = (newContent) => {
          setDocuments(prev => prev.map(doc => 
            doc.id === activeDocId ? { ...doc, content: newContent, updatedAt: Date.now() } : doc
          ));
        };

        const createNewDoc = () => {
          const newDoc = {
            id: 'doc-' + Date.now(),
            title: `未命名-${documents.length + 1}`,
            content: '',
            updatedAt: Date.now()
          };
          setDocuments(prev => [...prev, newDoc]);
          setActiveDocId(newDoc.id);
        };

        const closeDoc = (e, id) => {
          e.stopPropagation();
          if (documents.length === 1) {
            updateActiveDoc('');
            return;
          }
          const newDocs = documents.filter(d => d.id !== id);
          setDocuments(newDocs);
          if (id === activeDocId) {
            setActiveDocId(newDocs[newDocs.length - 1].id);
          }
        };

        const startRenaming = (doc) => {
          setEditingDocId(doc.id);
          setTempTitle(doc.title);
        };

        const saveRename = () => {
          if (editingDocId) {
             const newTitle = tempTitle.trim() || "未命名";
             setDocuments(prev => prev.map(d => d.id === editingDocId ? { ...d, title: newTitle } : d));
             setEditingDocId(null);
          }
        };

        const handleRenameKeyDown = (e) => {
          if (e.key === 'Enter') saveRename();
          if (e.key === 'Escape') setEditingDocId(null);
        };

        const handleImportFile = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            const content = e.target?.result;
            const newDoc = {
              id: 'doc-' + Date.now(),
              title: file.name.replace(/\.txt$/i, ''),
              content: content,
              updatedAt: Date.now()
            };
            setDocuments(prev => [...prev, newDoc]);
            setActiveDocId(newDoc.id);
          };
          reader.readAsText(file);
          if (fileInputRef.current) fileInputRef.current.value = '';
        };

        const handleExportFile = () => {
          const blob = new Blob([text], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `${activeDoc.title}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        };

        const handleCursorMove = (e) => {
          const textarea = e.currentTarget;
          const selectionStart = textarea.selectionStart;
          const value = textarea.value;
          const valueBeforeCursor = value.substring(0, selectionStart);
          const line = valueBeforeCursor.split('\n').length;
          const col = selectionStart - valueBeforeCursor.lastIndexOf('\n');
          setCursorStats({ line, col });
        };

        const handleCopy = () => {
          navigator.clipboard.writeText(text);
          triggerToast("已复制");
        };

        const scrollToTop = () => {
          if (editorRef.current) editorRef.current.scrollTop = 0;
        };

        const scrollToBottom = () => {
          if (editorRef.current) editorRef.current.scrollTop = editorRef.current.scrollHeight;
        };

        const handleDedupAnalysis = () => {
          const uniqueChars = new Set();
          const removedChars = [];
          let cleaned = "";
          for (const char of text) {
            if (uniqueChars.has(char)) {
              removedChars.push(char);
            } else {
              uniqueChars.add(char);
              cleaned += char;
            }
          }
          setDedupResult({
            original: text,
            cleaned,
            removedChars,
            removedCount: removedChars.length
          });
          setDedupModalOpen(true);
        };

        const applyDedup = (cleanedText) => {
          updateActiveDoc(cleanedText);
          setDedupModalOpen(false);
        };

        const handleSearch = (term) => {
          setSearchTerm(term);
          if (!term || !editorRef.current) return;
          const index = text.indexOf(term);
          if (index !== -1) {
            editorRef.current.focus();
            editorRef.current.setSelectionRange(index, index + term.length);
            const textBefore = text.substring(0, index);
            const linesBefore = textBefore.split('\n').length;
            const lineHeight = config.fontSize * (config.spacing === 'loose' ? 1.8 : 1.4);
            editorRef.current.scrollTop = (linesBefore - 1) * lineHeight;
            setCursorStats(prev => ({ ...prev, line: linesBefore }));
          }
        };

        const lineCount = useMemo(() => text.split('\n').length, [text]);
        const stats = useMemo(() => {
          const cleanText = text.replace(/\s/g, ''); 
          const charCount = cleanText.length;
          const uniqueCount = new Set(cleanText.split('')).size;
          const redundantCount = charCount - uniqueCount;
          return { charCount, redundantCount };
        }, [text]);

        const getFontFamily = () => {
          switch (config.fontFamily) {
            case 'serif': return "'Noto Serif SC', 'serif'";
            default: return "'Noto Sans SC', 'Inter', sans-serif";
          }
        };

        const textAreaStyle = {
          fontSize: `${config.fontSize}px`,
          lineHeight: config.spacing === 'loose' ? 1.8 : 1.4,
          letterSpacing: config.spacing === 'loose' ? '0.05em' : 'normal',
          fontFamily: getFontFamily(),
          textAlign: config.alignment,
          whiteSpace: 'pre-wrap',
          wordBreak: 'break-word',
        };

        return (
          <div className={`flex flex-col h-screen bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300`}>
            {/* Header */}
            <header className="flex-none h-20 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 bg-white/80 dark:bg-slate-900/90 backdrop-blur-md z-30 relative">
              <div className="flex items-center gap-4 overflow-x-auto no-scrollbar">
                <Tooltip content="返回首页" placement="bottom">
                  <a 
                    href="https://www.zizao.top/" 
                    target="_blank"
                    rel="noopener noreferrer"
                    className="flex items-center justify-center p-2 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:text-emerald-600 dark:hover:text-emerald-500 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors"
                  >
                    <Icons.Home size={20} />
                  </a>
                </Tooltip>

                <h1 className="hidden md:flex font-mono font-bold text-emerald-600 dark:text-emerald-500 tracking-tighter text-2xl items-center gap-2 whitespace-nowrap">
                  <span className="text-slate-800 dark:text-slate-100">自在文本编辑器</span>
                  <span className="text-sm font-normal px-2.5 py-1 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400">Pro</span>
                </h1>
                <div className="hidden md:block h-8 w-px bg-slate-300 dark:bg-slate-700 mx-3" />
                
                <div className="flex items-center bg-slate-100 dark:bg-slate-800 rounded-lg p-1.5">
                   <button 
                      onClick={() => setConfig(p => ({...p, fontSize: Math.max(12, p.fontSize - 1)}))}
                      className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
                   >
                     <Icons.Minus size={16} />
                   </button>
                   <input 
                      type="number"
                      value={config.fontSize}
                      onChange={(e) => {
                          const val = parseInt(e.target.value);
                          if (!isNaN(val) && val > 0 && val <= 200) setConfig(p => ({...p, fontSize: val}));
                      }}
                      className="w-12 text-center text-sm font-mono text-slate-600 dark:text-slate-300 bg-transparent outline-none appearance-none"
                   />
                   <button 
                      onClick={() => setConfig(p => ({...p, fontSize: Math.min(64, p.fontSize + 1)}))}
                      className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
                   >
                     <Icons.Plus size={16} />
                   </button>
                </div>

                <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-lg p-1.5">
                   <Tooltip content="紧凑模式" placement="bottom">
                      <button 
                        onClick={() => setConfig(p => ({...p, spacing: 'compact'}))}
                        className={`p-2 rounded-md transition-colors ${config.spacing === 'compact' ? 'bg-white dark:bg-slate-600 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}`}
                      >
                        <Icons.MoveVertical size={20} className="scale-75" />
                      </button>
                   </Tooltip>
                   <Tooltip content="宽松模式" placement="bottom">
                      <button 
                         onClick={() => setConfig(p => ({...p, spacing: 'loose'}))}
                         className={`p-2 rounded-md transition-colors ${config.spacing === 'loose' ? 'bg-white dark:bg-slate-600 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}`}
                      >
                         <Icons.MoveVertical size={20} />
                      </button>
                   </Tooltip>
                   <div className="w-px h-5 bg-slate-300 dark:bg-slate-700 mx-1"></div>
                   <button 
                     onClick={() => setConfig(p => ({...p, alignment: 'left'}))}
                     className={`p-2 rounded-md transition-colors ${config.alignment === 'left' ? 'bg-white dark:bg-slate-600 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}`}
                   >
                     <Icons.AlignLeft size={20} />
                   </button>
                   <button 
                     onClick={() => setConfig(p => ({...p, alignment: 'center'}))}
                     className={`p-2 rounded-md transition-colors ${config.alignment === 'center' ? 'bg-white dark:bg-slate-600 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}`}
                   >
                     <Icons.AlignCenter size={20} />
                   </button>
                   <button 
                     onClick={() => setConfig(p => ({...p, alignment: 'right'}))}
                     className={`p-2 rounded-md transition-colors ${config.alignment === 'right' ? 'bg-white dark:bg-slate-600 shadow-sm text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white'}`}
                   >
                     <Icons.AlignRight size={20} />
                   </button>
                </div>

                <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-800 rounded-lg p-1.5">
                   <Tooltip content="切换为黑体/宋体" placement="bottom">
                       <button 
                         onClick={() => setConfig(p => ({...p, fontFamily: p.fontFamily === 'sans' ? 'serif' : 'sans'}))}
                         className="p-2 px-3 rounded-md text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-white dark:hover:bg-slate-700 hover:shadow-sm transition-all min-w-[48px]"
                       >
                         {config.fontFamily === 'sans' ? '黑体' : '宋体'}
                       </button>
                   </Tooltip>
                   <div className="w-px h-5 bg-slate-300 dark:bg-slate-700 mx-1"></div>
                   <Tooltip content="宽度切换 (全屏 / 阅读)" placement="bottom">
                       <button 
                         onClick={() => setConfig(p => ({...p, width: p.width === 'full' ? 'narrow' : 'full'}))}
                         className="p-2 rounded-md text-slate-500 dark:text-slate-400 hover:bg-white dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-white transition-colors"
                       >
                          {config.width === 'full' ? <Icons.Minimize2 size={20} /> : <Icons.Maximize2 size={20} />}
                       </button>
                   </Tooltip>
                </div>
              </div>

              <div className="flex items-center gap-4">
                <Tooltip content={theme === 'dark' ? "切换亮色模式" : "切换暗色模式"} placement="bottom">
                  <button
                      onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')}
                      className="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400 transition-colors"
                  >
                      {theme === 'dark' ? <Icons.Sun size={20} /> : <Icons.Moon size={20} />}
                  </button>
                </Tooltip>

                <div className={`relative flex items-center transition-all duration-300 ${isSearchOpen ? 'w-72' : 'w-12'}`}>
                  {isSearchOpen ? (
                      <div className="relative w-full">
                          <input 
                              ref={searchInputRef}
                              type="text" 
                              value={searchTerm}
                              onChange={(e) => handleSearch(e.target.value)}
                              placeholder="查找..."
                              className="w-full bg-slate-100 dark:bg-slate-800 text-base text-slate-900 dark:text-white rounded-full pl-5 pr-10 py-2 focus:outline-none border border-slate-200 dark:border-slate-700 focus:border-emerald-500 dark:focus:border-emerald-500"
                          />
                          <button 
                              onClick={() => { setIsSearchOpen(false); setSearchTerm(''); }}
                              className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-900 dark:hover:text-white"
                          >
                              <Icons.X size={16} />
                          </button>
                      </div>
                  ) : (
                      <Tooltip content="查找字符" placement="bottom">
                          <button 
                              onClick={() => setIsSearchOpen(true)}
                              className="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
                          >
                              <Icons.Search size={20} />
                          </button>
                      </Tooltip>
                  )}
                </div>
                
                <div className="h-8 w-px bg-slate-300 dark:bg-slate-700 mx-1" />

                <Tooltip content="导出为本地TXT文件" placement="bottom">
                  <button 
                    onClick={handleExportFile}
                    className="p-2.5 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white transition-colors"
                  >
                    <Icons.Download size={20} />
                  </button>
                </Tooltip>

                <Tooltip content="复制当前页字符" placement="bottom">
                  <button 
                    onClick={handleCopy}
                    className="p-2.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-full transition-colors shadow-lg shadow-emerald-900/20 dark:shadow-emerald-900/40"
                  >
                    <Icons.Copy size={20} />
                  </button>
                </Tooltip>
              </div>
            </header>

            {/* Tab Bar */}
            <div className="flex-none h-12 bg-slate-100/80 dark:bg-slate-950/80 border-b border-slate-200 dark:border-slate-800 flex items-center px-2 overflow-x-auto no-scrollbar z-20">
              {documents.map((doc) => (
                 <div 
                   key={doc.id}
                   onClick={() => setActiveDocId(doc.id)}
                   onDoubleClick={() => startRenaming(doc)}
                   className={`
                      group relative flex items-center gap-2 px-4 py-3 text-sm font-medium min-w-[140px] max-w-[240px] cursor-pointer border-r border-slate-200 dark:border-slate-800 select-none transition-colors
                      ${activeDocId === doc.id 
                          ? 'bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 shadow-sm' 
                          : 'text-slate-500 dark:text-slate-500 hover:bg-slate-50/50 dark:hover:bg-slate-900/50 hover:text-slate-700 dark:hover:text-slate-400'}
                   `}
                 >
                   <Icons.FileText size={16} className={activeDocId === doc.id ? 'text-emerald-500' : 'opacity-50'} />
                   
                   {editingDocId === doc.id ? (
                      <input 
                        ref={renameInputRef}
                        type="text"
                        value={tempTitle}
                        onChange={(e) => setTempTitle(e.target.value)}
                        onBlur={saveRename}
                        onKeyDown={handleRenameKeyDown}
                        className="w-full bg-white dark:bg-slate-800 border border-emerald-500 rounded px-1 py-0.5 outline-none text-slate-900 dark:text-white"
                      />
                   ) : (
                      <span className="truncate flex-1">{doc.title}</span>
                   )}

                   <button 
                      onClick={(e) => closeDoc(e, doc.id)}
                      className={`p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 ${activeDocId === doc.id ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity`}
                   >
                     <Icons.X size={14} />
                   </button>
                   {activeDocId === doc.id && (
                      <div className="absolute top-0 left-0 right-0 h-[3px] bg-emerald-500" />
                   )}
                 </div>
              ))}

              <div className="flex items-center ml-3 gap-2">
                  <Tooltip content="新建文档" placement="right">
                      <button 
                          onClick={createNewDoc}
                          className="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors"
                      >
                          <Icons.Plus size={20} />
                      </button>
                  </Tooltip>
                  <Tooltip content="打开本地 TXT" placement="right">
                      <button 
                          onClick={() => fileInputRef.current?.click()}
                          className="p-2 hover:bg-slate-200 dark:hover:bg-slate-800 rounded text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors"
                      >
                          <Icons.FolderOpen size={20} />
                      </button>
                  </Tooltip>
                  <input 
                      type="file" 
                      ref={fileInputRef}
                      onChange={handleImportFile}
                      accept=".txt"
                      className="hidden"
                  />
              </div>
            </div>

            {/* Main Area */}
            <main className="flex-1 relative overflow-hidden flex flex-col items-center">
              
              <div className={`flex-1 w-full h-full flex flex-col ${config.width === 'narrow' ? 'max-w-4xl border-x border-slate-100 dark:border-slate-800/50 bg-white/50 dark:bg-slate-900/50' : ''} transition-all duration-500`}>
                <textarea
                  ref={editorRef}
                  value={text}
                  onChange={(e) => { updateActiveDoc(e.target.value); handleCursorMove(e); }}
                  onClick={handleCursorMove}
                  onKeyUp={handleCursorMove}
                  onSelect={handleCursorMove}
                  placeholder="在此输入文本..."
                  className="flex-1 w-full h-full bg-transparent resize-none outline-none p-10 md:p-16 custom-scrollbar text-slate-800 dark:text-slate-200 placeholder:text-slate-400 dark:placeholder:text-slate-600 transition-all duration-300"
                  style={textAreaStyle}
                  spellCheck={false}
                />
              </div>

              {/* Float Buttons */}
              <div className="absolute right-8 top-1/2 -translate-y-1/2 flex flex-col gap-5 z-10">
                 <Tooltip content="去除重复字符" placement="left">
                    <button 
                      onClick={handleDedupAnalysis}
                      className="w-12 h-12 flex items-center justify-center rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:text-rose-500 dark:hover:text-rose-400 hover:border-rose-500/50 shadow-lg transition-all hover:scale-110"
                    >
                      <Icons.Eraser size={22} />
                    </button>
                 </Tooltip>

                 <Tooltip content="汉字转拼音" placement="left">
                    <button 
                      onClick={() => setPinyinModalOpen(true)}
                      className="w-12 h-12 flex items-center justify-center rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:text-indigo-500 dark:hover:text-indigo-400 hover:border-indigo-500/50 shadow-lg transition-all hover:scale-110"
                    >
                      <Icons.Languages size={22} />
                    </button>
                 </Tooltip>

                 <Tooltip content="文本差异对比" placement="left">
                    <button 
                      onClick={() => setDiffModalOpen(true)}
                      className="w-12 h-12 flex items-center justify-center rounded-full bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:text-sky-500 dark:hover:text-sky-400 hover:border-sky-500/50 shadow-lg transition-all hover:scale-110"
                    >
                      <Icons.SplitSquareHorizontal size={22} />
                    </button>
                 </Tooltip>
              </div>

              {/* Nav Buttons */}
              <div className="absolute bottom-8 right-8 flex flex-col gap-3 z-10">
                  <Tooltip content="回到顶部" placement="left">
                      <button 
                          onClick={scrollToTop}
                          className="p-3 bg-white/80 dark:bg-slate-800/80 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white rounded-lg backdrop-blur-sm transition-colors border border-slate-200 dark:border-slate-700 shadow-sm"
                      >
                          <Icons.ArrowUpToLine size={20} />
                      </button>
                  </Tooltip>
                  <Tooltip content="去到底部" placement="left">
                      <button 
                          onClick={scrollToBottom}
                          className="p-3 bg-white/80 dark:bg-slate-800/80 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white rounded-lg backdrop-blur-sm transition-colors border border-slate-200 dark:border-slate-700 shadow-sm"
                      >
                          <Icons.ArrowDownToLine size={20} />
                      </button>
                  </Tooltip>
              </div>

              {/* Status Bar */}
              <div className="absolute bottom-6 left-6 md:left-10 flex items-center gap-3 sm:gap-4 text-sm font-mono text-slate-400 dark:text-slate-500 pointer-events-none select-none flex-wrap">
                  <span className="bg-white/50 dark:bg-slate-800/50 px-3 py-1.5 rounded border border-slate-200 dark:border-slate-800 text-emerald-600 dark:text-emerald-500 font-bold">
                      当前在第 {cursorStats.line} 行
                  </span>
                  <span className="hidden sm:inline-block text-slate-300 dark:text-slate-700">|</span>
                  <span className="bg-white/50 dark:bg-slate-800/50 px-3 py-1.5 rounded border border-slate-200 dark:border-slate-800">
                      总行数: {lineCount}
                  </span>
                  <span className="bg-white/50 dark:bg-slate-800/50 px-3 py-1.5 rounded border border-slate-200 dark:border-slate-800">
                      字符数: {stats.charCount}
                  </span>
                   <span className="bg-white/50 dark:bg-slate-800/50 px-3 py-1.5 rounded border border-slate-200 dark:border-slate-800">
                      重复: {stats.redundantCount}
                  </span>
              </div>

              {/* Toast */}
              {toastMessage && <Toast message={toastMessage} />}

            </main>

            {/* Modals */}
            <Modal 
              isOpen={dedupModalOpen} 
              onClose={() => setDedupModalOpen(false)} 
              title="去除重复字符"
            >
              <DedupView result={dedupResult} onApply={applyDedup} triggerToast={triggerToast} />
            </Modal>

            <Modal 
              isOpen={pinyinModalOpen} 
              onClose={() => setPinyinModalOpen(false)} 
              title="汉字转拼音"
            >
              <PinyinView currentText={text} triggerToast={triggerToast} />
            </Modal>

            <Modal 
              isOpen={diffModalOpen} 
              onClose={() => setDiffModalOpen(false)} 
              title="文本差异对比"
              width="max-w-5xl"
            >
              <DiffView triggerToast={triggerToast} />
            </Modal>
          </div>
        );
      }

      // Mount the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
      
      // Remove loading screen when done
      const loader = document.getElementById('app-loading');
      if (loader) loader.style.display = 'none';

    </script>
  </body>
</html>